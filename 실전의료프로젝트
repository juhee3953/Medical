"""
ë³‘ì› ì¢…í•© ê´€ë¦¬ ì‹œìŠ¤í…œ (Hospital Management System)
- í™˜ì ë“±ë¡ ë° ê´€ë¦¬
- ì˜ì‚¬ ê´€ë¦¬
- ì§„ë£Œ ì˜ˆì•½
- ì§„ë£Œ ê¸°ë¡
- í†µê³„ ë° ë¦¬í¬íŠ¸
- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
"""

import json
import os
from datetime import datetime
from typing import List, Dict, Optional

# ============ ì˜ˆì™¸ í´ë˜ìŠ¤ ============
class HospitalError(Exception):
    """ë³‘ì› ì‹œìŠ¤í…œ ê¸°ë³¸ ì˜ˆì™¸"""
    pass

class PatientNotFoundError(HospitalError):
    """í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"""
    pass

class DoctorNotFoundError(HospitalError):
    """ì˜ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"""
    pass

# ============ ê¸°ë³¸ í´ë˜ìŠ¤ ============
class Person:
    """ì‚¬ëŒ ê¸°ë³¸ í´ë˜ìŠ¤"""
    def __init__(self, name: str, age: int, phone: str):
        self.name = name
        self.age = age
        self.phone = phone
    
    def to_dict(self) -> Dict:
        return {
            "name": self.name,
            "age": self.age,
            "phone": self.phone
        }

class Patient(Person):
    """í™˜ì í´ë˜ìŠ¤"""
    _id_counter = 1000
    
    def __init__(self, name: str, age: int, phone: str, blood_type: str):
        super().__init__(name, age, phone)
        self.patient_id = f"P-{Patient._id_counter}"
        Patient._id_counter += 1
        self.blood_type = blood_type
        self.medical_records: List[Dict] = []
    
    def add_record(self, diagnosis: str, doctor_name: str, prescription: str = ""):
        """ì§„ë£Œ ê¸°ë¡ ì¶”ê°€"""
        record = {
            "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "diagnosis": diagnosis,
            "doctor": doctor_name,
            "prescription": prescription
        }
        self.medical_records.append(record)
    
    def get_latest_record(self) -> Optional[Dict]:
        """ìµœê·¼ ì§„ë£Œ ê¸°ë¡"""
        return self.medical_records[-1] if self.medical_records else None
    
    def to_dict(self) -> Dict:
        data = super().to_dict()
        data.update({
            "patient_id": self.patient_id,
            "blood_type": self.blood_type,
            "medical_records": self.medical_records
        })
        return data
    
    def __str__(self):
        return f"{self.name} ({self.patient_id}, {self.age}ì„¸, {self.blood_type}í˜•)"

class Doctor(Person):
    """ì˜ì‚¬ í´ë˜ìŠ¤"""
    def __init__(self, name: str, age: int, phone: str, 
                 department: str, license_number: str):
        super().__init__(name, age, phone)
        self.department = department
        self.license_number = license_number
        self.appointments: List[Dict] = []
    
    def add_appointment(self, patient_id: str, date: str, time: str):
        """ì˜ˆì•½ ì¶”ê°€"""
        appointment = {
            "patient_id": patient_id,
            "date": date,
            "time": time,
            "status": "scheduled"
        }
        self.appointments.append(appointment)
    
    def complete_appointment(self, patient_id: str):
        """ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬"""
        for apt in self.appointments:
            if apt["patient_id"] == patient_id and apt["status"] == "scheduled":
                apt["status"] = "completed"
                break
    
    def to_dict(self) -> Dict:
        data = super().to_dict()
        data.update({
            "department": self.department,
            "license_number": self.license_number,
            "appointments": self.appointments
        })
        return data
    
    def __str__(self):
        return f"{self.name} ì˜ì‚¬ ({self.department})"

# ============ ë³‘ì› ê´€ë¦¬ ì‹œìŠ¤í…œ ============
class Hospital:
    """ë³‘ì› ì¢…í•© ê´€ë¦¬ ì‹œìŠ¤í…œ"""
    
    def __init__(self, name: str, data_dir: str = "hospital_data"):
        self.name = name
        self.data_dir = data_dir
        self.patients: Dict[str, Patient] = {}
        self.doctors: Dict[str, Doctor] = {}
        
        # ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
        os.makedirs(data_dir, exist_ok=True)
        
        # ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
        self.load_data()
    
    # ===== í™˜ì ê´€ë¦¬ =====
    def register_patient(self, name: str, age: int, phone: str, blood_type: str) -> Patient:
        """í™˜ì ë“±ë¡"""
        patient = Patient(name, age, phone, blood_type)
        self.patients[patient.patient_id] = patient
        self.save_data()
        print(f"âœ… {name}ë‹˜ ë“±ë¡ ì™„ë£Œ (ID: {patient.patient_id})")
        return patient
    
    def find_patient(self, patient_id: str) -> Patient:
        """í™˜ì ê²€ìƒ‰"""
        if patient_id not in self.patients:
            raise PatientNotFoundError(f"í™˜ì {patient_id}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return self.patients[patient_id]
    
    def search_patients_by_name(self, name: str) -> List[Patient]:
        """ì´ë¦„ìœ¼ë¡œ í™˜ì ê²€ìƒ‰"""
        return [p for p in self.patients.values() if name in p.name]
    
    # ===== ì˜ì‚¬ ê´€ë¦¬ =====
    def hire_doctor(self, name: str, age: int, phone: str, 
                    department: str, license_number: str) -> Doctor:
        """ì˜ì‚¬ ì±„ìš©"""
        doctor = Doctor(name, age, phone, department, license_number)
        self.doctors[license_number] = doctor
        self.save_data()
        print(f"âœ… {name} ì˜ì‚¬ ì±„ìš© ì™„ë£Œ ({department})")
        return doctor
    
    def find_doctor(self, license_number: str) -> Doctor:
        """ì˜ì‚¬ ê²€ìƒ‰"""
        if license_number not in self.doctors:
            raise DoctorNotFoundError(f"ì˜ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return self.doctors[license_number]
    
    def get_doctors_by_department(self, department: str) -> List[Doctor]:
        """ì§„ë£Œê³¼ë³„ ì˜ì‚¬ ê²€ìƒ‰"""
        return [d for d in self.doctors.values() if d.department == department]
    
    # ===== ì§„ë£Œ =====
    def diagnose(self, patient_id: str, doctor_license: str, 
                 diagnosis: str, prescription: str = ""):
        """ì§„ë£Œ ì‹¤ì‹œ"""
        patient = self.find_patient(patient_id)
        doctor = self.find_doctor(doctor_license)
        
        patient.add_record(diagnosis, doctor.name, prescription)
        doctor.complete_appointment(patient_id)
        
        self.save_data()
        
        print(f"\nğŸ¥ ì§„ë£Œ ì™„ë£Œ")
        print(f"í™˜ì: {patient.name}")
        print(f"ì˜ì‚¬: {doctor.name}")
        print(f"ì§„ë‹¨: {diagnosis}")
        if prescription:
            print(f"ì²˜ë°©: {prescription}")
    
    # ===== ì˜ˆì•½ =====
    def make_appointment(self, patient_id: str, doctor_license: str, 
                        date: str, time: str):
        """ì˜ˆì•½ ìƒì„±"""
        patient = self.find_patient(patient_id)
        doctor = self.find_doctor(doctor_license)
        
        doctor.add_appointment(patient_id, date, time)
        self.save_data()
        
        print(f"âœ… ì˜ˆì•½ ì™„ë£Œ: {patient.name} -> {doctor.name}")
        print(f"   ì¼ì‹œ: {date} {time}")
    
    # ===== í†µê³„ ë° ë¦¬í¬íŠ¸ =====
    def get_statistics(self) -> Dict:
        """ë³‘ì› í†µê³„"""
        stats = {
            "ì´_í™˜ììˆ˜": len(self.patients),
            "ì´_ì˜ì‚¬ìˆ˜": len(self.doctors),
            "ì´_ì§„ë£Œê±´ìˆ˜": sum(len(p.medical_records) for p in self.patients.values()),
            "ì§„ë£Œê³¼ë³„_ì˜ì‚¬ìˆ˜": {}
        }
        
        # ì§„ë£Œê³¼ë³„ ì˜ì‚¬ ìˆ˜
        for doctor in self.doctors.values():
            dept = doctor.department
            stats["ì§„ë£Œê³¼ë³„_ì˜ì‚¬ìˆ˜"][dept] = stats["ì§„ë£Œê³¼ë³„_ì˜ì‚¬ìˆ˜"].get(dept, 0) + 1
        
        return stats
    
    def print_statistics(self):
        """í†µê³„ ì¶œë ¥"""
        stats = self.get_statistics()
        
        print("\n" + "=" * 60)
        print(f"ğŸ¥ {self.name} í†µê³„")
        print("=" * 60)
        print(f"ì´ í™˜ì ìˆ˜: {stats['ì´_í™˜ììˆ˜']}ëª…")
        print(f"ì´ ì˜ì‚¬ ìˆ˜: {stats['ì´_ì˜ì‚¬ìˆ˜']}ëª…")
        print(f"ì´ ì§„ë£Œ ê±´ìˆ˜: {stats['ì´_ì§„ë£Œê±´ìˆ˜']}ê±´")
        
        print("\nğŸ“Š ì§„ë£Œê³¼ë³„ ì˜ì‚¬ ìˆ˜:")
        for dept, count in stats["ì§„ë£Œê³¼ë³„_ì˜ì‚¬ìˆ˜"].items():
            print(f"  {dept}: {count}ëª…")
        print("=" * 60)
    
    def generate_patient_report(self, patient_id: str):
        """í™˜ì ë¦¬í¬íŠ¸ ìƒì„±"""
        patient = self.find_patient(patient_id)
        
        print("\n" + "=" * 60)
        print(f"ğŸ“‹ í™˜ì ì§„ë£Œ ë¦¬í¬íŠ¸")
        print("=" * 60)
        print(f"í™˜ì ID: {patient.patient_id}")
        print(f"ì´ë¦„: {patient.name}")
        print(f"ë‚˜ì´: {patient.age}ì„¸")
        print(f"í˜ˆì•¡í˜•: {patient.blood_type}í˜•")
        print(f"ì „í™”ë²ˆí˜¸: {patient.phone}")
        
        print(f"\nğŸ“ ì§„ë£Œ ê¸°ë¡ ({len(patient.medical_records)}ê±´):")
        print("-" * 60)
        
        if not patient.medical_records:
            print("ì§„ë£Œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            for i, record in enumerate(patient.medical_records, 1):
                print(f"\n[{i}] {record['date']}")
                print(f"    ì§„ë‹¨ëª…: {record['diagnosis']}")
                print(f"    ë‹´ë‹¹ì˜: {record['doctor']}")
                if record['prescription']:
                    print(f"    ì²˜ë°©: {record['prescription']}")
        
        print("\n" + "=" * 60)
    
    # ===== ë°ì´í„° ì €ì¥/ë¡œë“œ =====
    def save_data(self):
        """ë°ì´í„° ì €ì¥"""
        data = {
            "patients": {pid: p.to_dict() for pid, p in self.patients.items()},
            "doctors": {lic: d.to_dict() for lic, d in self.doctors.items()}
        }
        
        filepath = os.path.join(self.data_dir, "hospital_data.json")
        with open(filepath, "w", encoding="utf-8") as file:
            json.dump(data, file, ensure_ascii=False, indent=2)
    
    def load_data(self):
        """ë°ì´í„° ë¡œë“œ"""
        filepath = os.path.join(self.data_dir, "hospital_data.json")
        
        if not os.path.exists(filepath):
            return
        
        try:
            with open(filepath, "r", encoding="utf-8") as file:
                data = json.load(file)
            
            # í™˜ì ë³µì›
            for patient_data in data.get("patients", {}).values():
                patient = Patient(
                    patient_data["name"],
                    patient_data["age"],
                    patient_data["phone"],
                    patient_data["blood_type"]
                )
                patient.patient_id = patient_data["patient_id"]
                patient.medical_records = patient_data["medical_records"]
                self.patients[patient.patient_id] = patient
            
            # ì˜ì‚¬ ë³µì›
            for doctor_data in data.get("doctors", {}).values():
                doctor = Doctor(
                    doctor_data["name"],
                    doctor_data["age"],
                    doctor_data["phone"],
                    doctor_data["department"],
                    doctor_data["license_number"]
                )
                doctor.appointments = doctor_data["appointments"]
                self.doctors[doctor.license_number] = doctor
            
            print(f"âœ… ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
            print(f"   í™˜ì: {len(self.patients)}ëª…, ì˜ì‚¬: {len(self.doctors)}ëª…")
        
        except Exception as e:
            print(f"âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")

# ============ ë©”ì¸ í”„ë¡œê·¸ë¨ ============
def main():
    """ë©”ì¸ í”„ë¡œê·¸ë¨"""
    hospital = Hospital("ì„œìš¸ëŒ€í•™ë³‘ì›")
    
    print("\nğŸ¥ ë³‘ì› ê´€ë¦¬ ì‹œìŠ¤í…œ ì‹œì‘")
    print("=" * 60)
    
    # ì˜ì‚¬ ì±„ìš©
    print("\nğŸ‘¨â€âš•ï¸ ì˜ì‚¬ ì±„ìš©")
    doctor1 = hospital.hire_doctor("ê¹€ì˜ì‚¬", 40, "010-1111-2222", "ë‚´ê³¼", "D-001")
    doctor2 = hospital.hire_doctor("ì´ì˜ì‚¬", 38, "010-3333-4444", "ì™¸ê³¼", "D-002")
    doctor3 = hospital.hire_doctor("ë°•ì˜ì‚¬", 45, "010-5555-6666", "ë‚´ê³¼", "D-003")
    
    # í™˜ì ë“±ë¡
    print("\nğŸ‘¥ í™˜ì ë“±ë¡")
    patient1 = hospital.register_patient("ê¹€ì² ìˆ˜", 45, "010-1234-5678", "A")
    patient2 = hospital.register_patient("ì´ì˜í¬", 30, "010-2345-6789", "B")
    patient3 = hospital.register_patient("ë°•ë¯¼ìˆ˜", 55, "010-3456-7890", "O")
    
    # ì˜ˆì•½
    print("\nğŸ“… ì˜ˆì•½ ìƒì„±")
    hospital.make_appointment(patient1.patient_id, "D-001", "2024-03-15", "10:00")
    hospital.make_appointment(patient2.patient_id, "D-002", "2024-03-15", "11:00")
    
    # ì§„ë£Œ
    print("\nğŸ©º ì§„ë£Œ ì‹¤ì‹œ")
    hospital.diagnose(patient1.patient_id, "D-001", "ê³ í˜ˆì••", "í˜ˆì••ì•½ í•˜ë£¨ 1íšŒ ë³µìš©")
    hospital.diagnose(patient1.patient_id, "D-001", "ë‹¹ë‡¨", "í˜ˆë‹¹ ê´€ë¦¬ ë° ì‹ì´ìš”ë²•")
    hospital.diagnose(patient2.patient_id, "D-002", "ê³¨ì ˆ", "ê¹ìŠ¤ 4ì£¼")
    hospital.diagnose(patient3.patient_id, "D-003", "ê°ê¸°", "í•´ì—´ì œ ì²˜ë°©")
    
    # í™˜ì ë¦¬í¬íŠ¸
    hospital.generate_patient_report(patient1.patient_id)
    
    # í†µê³„
    hospital.print_statistics()
    
    # ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
    print("\nğŸ” í™˜ì ê²€ìƒ‰ (ì´ë¦„: ê¹€)")
    results = hospital.search_patients_by_name("ê¹€")
    for p in results:
        print(f"  {p}")
    
    print("\nğŸ” ë‚´ê³¼ ì˜ì‚¬ ê²€ìƒ‰")
    internal_doctors = hospital.get_doctors_by_department("ë‚´ê³¼")
    for d in internal_doctors:
        print(f"  {d}")
    
    print("\nâœ… ì‹œìŠ¤í…œ ì¢…ë£Œ")

if __name__ == "__main__":
    main()
